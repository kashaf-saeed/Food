;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="557f2969-4ddc-2762-1963-989e6985eb34")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,351895,e=>{"use strict";var s=e.i(38429),i=e.i(355901),a=e.i(234745);async function t({ref:e,identifier:s}){let i={};void 0!==s&&(i.database_identifier=s);let{data:t,error:r}=await (0,a.post)("/platform/projects/{ref}/restart",{params:{path:{ref:e}},body:i});return r&&(0,a.handleError)(r),t}e.s(["useProjectRestartMutation",0,({onSuccess:e,onError:a,...r}={})=>(0,s.useMutation)({mutationFn:e=>t(e),async onSuccess(s,i,a){await e?.(s,i,a)},async onError(e,s,t){void 0===a?i.toast.error(`Failed to restart project: ${e.message}`):a(e,s,t)},...r})])},554056,e=>{"use strict";var s,i=e.i(478902),a=e.i(902858),t=e.i(551456),r=e.i(88816);let n=(0,e.i(388019).default)("Earth",[["path",{d:"M21.54 15H17a2 2 0 0 0-2 2v4.54",key:"1djwo0"}],["path",{d:"M7 3.34V5a3 3 0 0 0 3 3a2 2 0 0 1 2 2c0 1.1.9 2 2 2a2 2 0 0 0 2-2c0-1.1.9-2 2-2h3.17",key:"1tzkfa"}],["path",{d:"M11 21.95V18a2 2 0 0 0-2-2a2 2 0 0 1-2-2v-1a2 2 0 0 0-2-2H2.05",key:"14pb5j"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);var l=e.i(774803),o=e.i(952786),d=e.i(896975),c=e.i(215261),p=e.i(389959),u=e.i(535487),h=e.i(351299),m=e.i(264903);e.i(128328);var x=e.i(158639),g=e.i(567558),f=e.i(215312),j=e.i(330287),b=e.i(150671),y=e.i(242882),_=e.i(234745),A=e.i(346691),S=((s={}).InProgress="in_progress",s.Completed="completed",s.Failed="failed",s);async function N({projectRef:e},s){if(!e)throw Error("Project ref is required");let{data:i,error:a}=await (0,_.get)("/platform/projects/{ref}/databases-statuses",{params:{path:{ref:e}},signal:s});return a&&(0,_.handleError)(a),i}let v=({projectRef:e},{enabled:s=!0,...i}={})=>(0,y.useQuery)({queryKey:A.replicaKeys.statuses(e),queryFn:({signal:s})=>N({projectRef:e},s),enabled:s&&void 0!==e,...i});var E=e.i(2579),I=e.i(912793),T=e.i(635494),C=e.i(48189),R=e.i(837710),w=e.i(874311),P=e.i(843778);e.i(744541);var D=e.i(355901),L=e.i(961753),k=e.i(819591),B=e.i(196621),O=e.i(513826),M=e.i(605317),$=e.i(38429);async function U({ref:e}){let{data:s,error:i}=await (0,_.post)("/platform/database/{ref}/backups/enable-physical-backups",{params:{path:{ref:e}}});return i&&(0,_.handleError)(i),s}var H=e.i(390473),z=e.i(164045),G=e.i(356003);async function V({projectRef:e,region:s}){let{data:i,error:a}=await (0,_.post)("/v1/projects/{ref}/read-replicas/setup",{params:{path:{ref:e}},body:{read_replica_region:s}});return a&&(0,_.handleError)(a),i}var W=e.i(144676),F=e.i(265735),Y=e.i(10429),Q=e.i(837508);e.i(427138);var q=e.i(434934),K=e.i(206413),Z=e.i(592360),X=e.i(178527),J=e.i(774234),ee=e.i(554855),es=e.i(925282),ei=e.i(331077),ea=e.i(539013),et=e.i(492418),er=e.i(877555),en=e.i(72187);let el=({visible:e,selectedDefaultRegion:s,onSuccess:t,onClose:n})=>{let{ref:l}=(0,x.useParams)(),{data:o}=(0,T.useSelectedProjectQuery)(),{data:d}=(0,F.useSelectedOrganizationQuery)(),{data:u}=(0,b.useReadReplicasQuery)({projectRef:l}),{data:h,isSuccess:m}=(0,W.useProjectAddonsQuery)({projectRef:l}),{data:g}=(0,M.useDiskAttributesQuery)({projectRef:l}),f=(0,p.useMemo)(()=>!["team","enterprise","platform"].includes(d?.plan.id??""),[d]),{data:j}=(0,H.useOverdueInvoicesQuery)({enabled:f}),y=(j??[]).filter(e=>e.organization_id===o?.organization_id).length>0&&f,_=(0,T.useIsAwsK8sCloudProvider)(),[S]=Object.entries(q.AWS_REGIONS).find(([e,s])=>s===Q.AWS_REGIONS_DEFAULT)??["ap-southeast-1"],N=h?.selected_addons.find(e=>"compute_instance"===e.type)?.variant.identifier??"ci_micro",{size_gb:v,type:E,throughput_mbps:I,iops:w}=g?.attributes??{},el=o?.cloud_provider==="AWS",eo=(v??0)*1.25*(k.DISK_PRICING[E]?.storage??0),ed=(0,L.calculateIOPSPrice)({oldStorageType:E,newStorageType:E,oldProvisionedIOPS:0,newProvisionedIOPS:w??0,numReplicas:0}).newPrice,ec="gp3"===E?(0,L.calculateThroughputPrice)({storageType:E,newThroughput:I??0,oldThroughput:0,numReplicas:0}).newPrice:0,[ep,eu]=(0,p.useState)(!1),[eh,em]=(0,p.useState)(S),[ex,eg]=(0,p.useState)(N),{data:ef,isSuccess:ej}=(0,z.useProjectDetailQuery)({ref:l},{refetchInterval:ep,refetchOnWindowFocus:!1});(0,p.useEffect)(()=>{ej&&ef.is_physical_backups_enabled&&eu(!1)},[ef?.is_physical_backups_enabled,ej]);let{mutate:eb,isPending:ey}=(({onSuccess:e,onError:s,...i}={})=>(0,$.useMutation)({mutationFn:e=>U(e),async onSuccess(s,i,a){await e?.(s,i,a)},async onError(e,i,a){void 0===s?D.toast.error(`Failed to enable physical backups: ${e.message}`):s(e,i,a)},...i}))({onSuccess:()=>{D.toast.success("Physical backups are currently being enabled, please check back in a few minutes!"),eu(5e3)}}),{mutate:e_,isPending:eA}=(({onSuccess:e,onError:s,...i}={})=>{let a=(0,G.useQueryClient)();return(0,$.useMutation)({mutationFn:e=>V(e),async onSuccess(s,i,t){let{projectRef:r}=i;await a.invalidateQueries({queryKey:A.replicaKeys.list(r)}),await e?.(s,i,t)},async onError(e,i,a){void 0===s?D.toast.error(`Failed to set up read replica: ${e.message}`):s(e,i,a)},...i})})({onSuccess:()=>{let e=en.AVAILABLE_REPLICA_REGIONS.find(e=>e.key===eh)?.name;D.toast.success(`Spinning up new replica in ${e??" Unknown"}...`),t(),n()}}),eS=Number((o?.dbVersion??"").split("supabase-postgres-")[1]?.split(".")[0]),eN=["ci_micro","ci_small","ci_medium","ci_large"].includes(ex)?b.MAX_REPLICAS_BELOW_XL:b.MAX_REPLICAS_ABOVE_XL,ev=(u??[]).filter(e=>e.identifier!==l).length>=eN,eE=d?.plan.id==="free",eI=o?.cloud_provider==="AWS",eT=o?.is_physical_backups_enabled,eC=h?.selected_addons.find(e=>"compute_instance"===e.type),eR=d?.plan.id==="pro"&&!d.usage_billing_enabled,ew=eC?.variant.identifier!==void 0&&eC?.variant.identifier!=="ci_micro",eP=!ev&&eS>=15&&eI&&!eE&&eT&&void 0!==eC&&!y&&!_&&!eR,eD=(h?.available_addons.find(e=>"compute_instance"===e.type)?.variants??[]).find(e=>e.identifier===ex),eL=Math.floor((eD?.price??0)*730),ek=en.AVAILABLE_REPLICA_REGIONS,eB=async()=>{let e=q.AWS_REGIONS[eh].code;if(!l)return console.error("Project is required");if(!e)return D.toast.error("Unable to deploy replica: Unsupported region selected");let s=u?.find(e=>e.identifier===l);e_({projectRef:l,region:e,size:s?.size??"t4g.small"})};return(0,p.useEffect)(()=>{e&&m&&(void 0!==s?em(s):S&&em(S),void 0!==N&&eg(N))},[e,m]),(0,i.jsx)(ea.SidePanel,{visible:e,onCancel:n,loading:eA,disabled:!eP,className:(0,P.cn)(el?"max-w-[500px]":""),header:"Deploy a new read replica",onConfirm:()=>eB(),confirmText:"Deploy replica",children:(0,i.jsxs)(ea.SidePanel.Content,{className:"flex flex-col py-4 gap-y-4",children:[y?(0,i.jsxs)(X.Alert_Shadcn_,{children:[(0,i.jsx)(er.WarningIcon,{}),(0,i.jsx)(Z.AlertTitle_Shadcn_,{children:"Your organization has overdue invoices"}),(0,i.jsxs)(K.AlertDescription_Shadcn_,{children:[(0,i.jsx)("span",{children:"Please resolve all outstanding invoices first before deploying a new read replica"}),(0,i.jsx)("div",{className:"mt-3",children:(0,i.jsx)(R.Button,{asChild:!0,type:"default",children:(0,i.jsx)(c.default,{href:`/org/${d?.slug}/billing#invoices`,children:"View invoices"})})})]})]}):eI?_?(0,i.jsxs)(X.Alert_Shadcn_,{children:[(0,i.jsx)(er.WarningIcon,{}),(0,i.jsx)(Z.AlertTitle_Shadcn_,{children:"Read replicas are not supported for AWS (Revamped) projects"}),(0,i.jsx)(K.AlertDescription_Shadcn_,{children:(0,i.jsx)("span",{children:"Projects provisioned by other cloud providers currently will not be able to use read replicas"})})]}):eS<15?(0,i.jsxs)(X.Alert_Shadcn_,{children:[(0,i.jsx)(er.WarningIcon,{}),(0,i.jsx)(Z.AlertTitle_Shadcn_,{children:"Read replicas can only be deployed with projects on Postgres version 15 and above"}),(0,i.jsx)(K.AlertDescription_Shadcn_,{children:"If you'd like to use read replicas, please contact us via support"}),(0,i.jsx)(K.AlertDescription_Shadcn_,{className:"mt-2",children:(0,i.jsx)(R.Button,{type:"default",children:(0,i.jsx)(B.SupportLink,{queryParams:{projectRef:l,category:a.SupportCategories.SALES_ENQUIRY,subject:"Enquiry on read replicas",message:`Project DB version: ${o?.dbVersion}`},children:"Contact support"})})})]}):ew?eT?eR?(0,i.jsxs)(X.Alert_Shadcn_,{children:[(0,i.jsx)(er.WarningIcon,{}),(0,i.jsx)(Z.AlertTitle_Shadcn_,{children:"Spend cap needs to be disabled to deploy replicas"}),(0,i.jsxs)(K.AlertDescription_Shadcn_,{children:[(0,i.jsx)("span",{children:"Launching a replica incurs additional disk size that will exceed the plan's quota. Disable the spend cap first to allow overages before launching a replica."}),(0,i.jsx)("div",{className:"flex items-center gap-x-2 mt-3",children:(0,i.jsx)(R.Button,{asChild:!0,type:"default",children:(0,i.jsx)(c.default,{href:`/org/${d?.slug}/billing?panel=costControl`,children:"Disable spend cap"})})})]})]}):ev?(0,i.jsxs)(X.Alert_Shadcn_,{children:[(0,i.jsx)(er.WarningIcon,{}),(0,i.jsxs)(Z.AlertTitle_Shadcn_,{children:["You can only deploy up to ",eN," read replicas at once"]}),(0,i.jsx)(K.AlertDescription_Shadcn_,{children:"If you'd like to spin up another read replica, please drop an existing replica first."}),eN===b.MAX_REPLICAS_BELOW_XL&&(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)(K.AlertDescription_Shadcn_,{children:[(0,i.jsxs)("span",{children:["Alternatively, you may deploy up to"," ",(0,i.jsx)("span",{className:"text-foreground",children:b.MAX_REPLICAS_ABOVE_XL})," replicas if your project is on an XL compute or higher."]}),(0,i.jsx)("div",{className:"flex items-center gap-x-2 mt-3",children:(0,i.jsx)(R.Button,{asChild:!0,type:"default",children:(0,i.jsx)(c.default,{href:eE?`/org/${d?.slug}/billing?panel=subscriptionPlan&source=deployNewReplicaPanelMaxReplicas`:`/project/${l}/settings/compute-and-disk`,children:"Upgrade compute size"})})})]})})]}):null:(0,i.jsxs)(X.Alert_Shadcn_,{children:[(0,i.jsx)(er.WarningIcon,{}),(0,i.jsx)(Z.AlertTitle_Shadcn_,{children:!1!==ep?"Physical backups are currently being enabled":"Physical backups are required to deploy replicas"}),!1===ep&&(0,i.jsx)(K.AlertDescription_Shadcn_,{className:"mb-2",children:"Physical backups are used under the hood to spin up read replicas for your project."}),(0,i.jsx)(K.AlertDescription_Shadcn_,{children:!1!==ep?"This warning will go away once physical backups have been enabled - check back in a few minutes!":"Enabling physical backups will take a few minutes, after which you will be able to deploy read replicas."}),!1!==ep?(0,i.jsx)(K.AlertDescription_Shadcn_,{className:"mt-2",children:"You may start deploying read replicas thereafter once this is completed."}):(0,i.jsxs)(K.AlertDescription_Shadcn_,{className:"flex items-center gap-x-2 mt-3",children:[(0,i.jsx)(R.Button,{type:"default",loading:ey,disabled:ey,onClick:()=>{l&&eb({ref:l})},children:"Enable physical backups"}),(0,i.jsx)(O.DocsButton,{abbrev:!1,href:`${Y.DOCS_URL}/guides/platform/read-replicas#how-are-read-replicas-made`})]})]}):(0,i.jsxs)(X.Alert_Shadcn_,{children:[(0,i.jsx)(er.WarningIcon,{}),(0,i.jsx)(Z.AlertTitle_Shadcn_,{children:"Project required to at least be on a Small compute"}),(0,i.jsxs)(K.AlertDescription_Shadcn_,{children:[(0,i.jsx)("span",{children:"This is to ensure that read replicas can keep up with the primary databases' activities."}),(0,i.jsxs)("div",{className:"flex items-center gap-x-2 mt-3",children:[(0,i.jsx)(R.Button,{asChild:!0,type:"default",children:(0,i.jsx)(c.default,{href:eE?`/org/${d?.slug}/billing?panel=subscriptionPlan&source=deployNewReplicaPanelSmallCompute`:`/project/${l}/settings/compute-and-disk`,children:eE?"Upgrade to Pro":"Change compute size"})}),(0,i.jsx)(O.DocsButton,{abbrev:!1,href:`${Y.DOCS_URL}/guides/platform/read-replicas#prerequisites`})]})]})]}):(0,i.jsxs)(X.Alert_Shadcn_,{children:[(0,i.jsx)(er.WarningIcon,{}),(0,i.jsx)(Z.AlertTitle_Shadcn_,{children:"Read replicas are only supported for projects provisioned via AWS"}),(0,i.jsxs)(K.AlertDescription_Shadcn_,{children:[(0,i.jsx)("span",{children:"Projects provisioned by other cloud providers currently will not be able to use read replicas"}),(0,i.jsx)(O.DocsButton,{abbrev:!1,className:"mt-3",href:`${Y.DOCS_URL}/guides/platform/read-replicas#prerequisites`})]})]}),(0,i.jsxs)("div",{className:"flex flex-col gap-y-6 mt-2",children:[(0,i.jsx)(ei.Listbox,{size:"small",id:"region",name:"region",disabled:!eP,value:eh,onChange:em,label:"Select a region to deploy your read replica in",children:ek.map(e=>(0,i.jsx)(ei.Listbox.Option,{label:e.name,value:e.key,addOnBefore:()=>(0,i.jsx)("img",{alt:"region icon",className:"w-5 rounded-sm",src:`${Y.BASE_PATH}/img/regions/${e.region}.svg`}),children:(0,i.jsxs)("p",{className:"flex items-center gap-x-2",children:[(0,i.jsx)("span",{children:e.name}),(0,i.jsx)("span",{className:"text-xs text-foreground-lighter font-mono",children:e.region})]})},e.key))}),(0,i.jsxs)("div",{className:"flex flex-col gap-y-2",children:[el?(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)(es.Collapsible_Shadcn_,{children:[(0,i.jsxs)(ee.CollapsibleTrigger_Shadcn_,{className:"w-full flex items-center justify-between [&[data-state=open]>svg]:!-rotate-180",children:[(0,i.jsxs)("p",{className:"text-sm text-left",children:["New replica will cost an additional"," ",(0,i.jsxs)("span",{translate:"no",children:[(0,C.formatCurrency)(eL+eo+Number(ed)+Number(ec)),"/month"]})]}),(0,i.jsx)(r.ChevronDown,{size:14,className:"transition"})]}),(0,i.jsxs)(J.CollapsibleContent_Shadcn_,{className:"flex flex-col gap-y-1 mt-1",children:[(0,i.jsx)("p",{className:"text-foreground-light text-sm",children:"Read replicas will match the compute size of your primary database and will include 25% more disk size than the primary database to accommodate WAL files."}),(0,i.jsx)("p",{className:"text-foreground-light text-sm",children:"The additional cost for the replica breaks down to:"}),(0,i.jsxs)(et.Table,{children:[(0,i.jsx)(et.TableHeader,{className:"font-mono uppercase text-xs [&_th]:h-auto [&_th]:pb-2 [&_th]:pt-4",children:(0,i.jsxs)(et.TableRow,{children:[(0,i.jsx)(et.TableHead,{className:"w-[140px] pl-0",children:"Item"}),(0,i.jsx)(et.TableHead,{children:"Description"}),(0,i.jsx)(et.TableHead,{className:"text-right pr-0",children:"Cost (/month)"})]})}),(0,i.jsxs)(et.TableBody,{className:"[&_td]:py-0 [&_tr]:h-[50px] [&_tr]:border-dotted",children:[(0,i.jsxs)(et.TableRow,{children:[(0,i.jsx)(et.TableCell,{className:"pl-0",children:"Compute size"}),(0,i.jsx)(et.TableCell,{children:eD?.name}),(0,i.jsx)(et.TableCell,{className:"text-right font-mono pr-0",translate:"no",children:(0,C.formatCurrency)(eL)})]}),(0,i.jsxs)(et.TableRow,{children:[(0,i.jsx)(et.TableCell,{className:"pl-0",children:"Disk size"}),(0,i.jsxs)(et.TableCell,{children:[((v??0)*1.25).toLocaleString()," GB (",E,")"]}),(0,i.jsx)(et.TableCell,{className:"text-right font-mono pr-0",translate:"no",children:(0,C.formatCurrency)(eo)})]}),(0,i.jsxs)(et.TableRow,{children:[(0,i.jsx)(et.TableCell,{className:"pl-0",children:"IOPS"}),(0,i.jsxs)(et.TableCell,{children:[w?.toLocaleString()," IOPS"]}),(0,i.jsx)(et.TableCell,{className:"text-right font-mono pr-0",translate:"no",children:(0,C.formatCurrency)(+ed)})]}),"gp3"===E&&(0,i.jsxs)(et.TableRow,{children:[(0,i.jsx)(et.TableCell,{className:"pl-0",children:"Throughput"}),(0,i.jsxs)(et.TableCell,{children:[I?.toLocaleString()," MB/s"]}),(0,i.jsx)(et.TableCell,{className:"text-right font-mono pr-0",children:(0,C.formatCurrency)(+ec)})]})]})]})]})]})}):(0,i.jsxs)("p",{className:"text-foreground-light text-sm",children:["Read replicas will be on the same compute size as your primary database. Deploying a read replica on the"," ",(0,i.jsx)("span",{className:"text-foreground",children:eD?.name})," size incurs additional"," ",(0,i.jsx)("span",{className:"text-foreground",translate:"no",children:eD?.price_description}),"."]}),(0,i.jsxs)("p",{className:"text-foreground-light text-sm",children:["Read more about"," ",(0,i.jsx)(c.default,{href:`${Y.DOCS_URL}/guides/platform/manage-your-usage/read-replicas`,target:"_blank",rel:"noreferrer",className:"underline hover:text-foreground transition",children:"billing"})," ","for read replicas."]})]})]})]})})};async function eo({projectRef:e,identifier:s}){let{data:i,error:a}=await (0,_.post)("/v1/projects/{ref}/read-replicas/remove",{params:{path:{ref:e}},body:{database_identifier:s}});return a&&(0,_.handleError)(a),i}let ed=({onSuccess:e,onError:s,...i}={})=>{let a=(0,G.useQueryClient)();return(0,$.useMutation)({mutationFn:e=>eo(e),async onSuccess(s,i,t){let{projectRef:r,invalidateReplicaQueries:n}=i;n&&await Promise.all([a.invalidateQueries({queryKey:A.replicaKeys.list(r)}),a.invalidateQueries({queryKey:A.replicaKeys.loadBalancers(r)})]),await e?.(s,i,t)},async onError(e,i,a){void 0===s?D.toast.error(`Failed to remove read replica: ${e.message}`):s(e,i,a)},...i})};var ec=e.i(466472);let ep=({visible:e,onSuccess:s,onCancel:a})=>{let{ref:t}=(0,x.useParams)(),r=(0,G.useQueryClient)(),{data:n}=(0,b.useReadReplicasQuery)({projectRef:t}),{mutateAsync:l,isPending:o}=ed(),d=async()=>{if(!t)return console.error("Project is required");if(void 0===n)return console.error("Unable to retrieve replicas");1===n.length&&(0,D.toast)("Your project has no read replicas");let e=n.filter(e=>e.identifier!==t);try{await Promise.all(e.map(e=>l({projectRef:t,identifier:e.identifier,invalidateReplicaQueries:!1}))),D.toast.success("Tearing down all read replicas"),await Promise.all([r.invalidateQueries({queryKey:A.replicaKeys.list(t)}),r.invalidateQueries({queryKey:A.replicaKeys.loadBalancers(t)})]),s(),a()}catch(e){D.toast.error("Failed to drop all replicas")}};return(0,i.jsxs)(ec.default,{variant:"destructive",size:"medium",loading:o,visible:e,title:"Confirm to drop all read replicas?",confirmLabel:"Drop all replicas",confirmLabelLoading:"Dropping all replicas",onCancel:()=>a(),onConfirm:()=>d(),alert:{title:"This action cannot be undone",description:"You may still deploy new replicas in this region thereafter"},children:[(0,i.jsx)("p",{className:"text-sm",children:"Before deleting all replicas, consider:"}),(0,i.jsx)("ul",{className:"text-sm text-foreground-light list-disc pl-6",children:(0,i.jsx)("li",{children:"Network traffic from this region may slow down"})})]})};var eu=e.i(940009);let eh=({selectedReplica:e,onSuccess:s,onCancel:a})=>{let{ref:t}=(0,x.useParams)(),r=(0,eu.formatDatabaseID)(e?.identifier??""),{mutate:n,isPending:l}=ed({onSuccess:()=>{D.toast.success(`Tearing down read replica (ID: ${r})`),s(),a()}}),o=async()=>t?void 0===e?D.toast.error("No replica selected"):void n({projectRef:t,identifier:e.identifier,invalidateReplicaQueries:!0}):console.error("Project is required");return(0,i.jsxs)(ec.default,{variant:"destructive",size:"medium",loading:l,visible:void 0!==e,title:`Confirm to drop selected replica? (ID: ${r})`,confirmLabel:"Drop replica",confirmLabelLoading:"Dropping replica",onCancel:()=>a(),onConfirm:()=>o(),alert:{title:"This action cannot be undone",description:"You may still deploy a new replica in this region thereafter"},children:[(0,i.jsx)("p",{className:"text-sm",children:"Before deleting this replica, consider:"}),(0,i.jsx)("ul",{className:"text-sm text-foreground-light py-1 list-disc mx-4 space-y-1",children:(0,i.jsx)("li",{children:"Network traffic from this region may slow down, especially if you have no other replicas in this region"})})]})};var em=e.i(714403);async function ex({projectRef:e,connectionString:s,id:i},a){let t=`
select 
  case
    when (select count(*) from pg_stat_wal_receiver) = 1 and pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn()
    then 0
    else coalesce(extract(epoch from now() - pg_last_xact_replay_timestamp()),0)
  end as physical_replica_lag_second
  `,{result:r}=await (0,em.executeSql)({projectRef:e,connectionString:s,sql:t,queryKey:["replica-lag",i]},a);return Number((r[0]??null)?.physical_replica_lag_second??0)}var eg=e.i(613580);let ef=({id:e,sourceX:s,sourceY:a,targetX:t,targetY:r,sourcePosition:n,targetPosition:o,style:d={},markerEnd:c,data:p})=>{let{ref:u}=(0,x.useParams)(),{status:h,identifier:g,connectionString:f}=p||{},j=(0,eu.formatDatabaseID)(g??""),[b,_,S]=(0,m.getSmoothStepPath)({sourceX:s,sourceY:a,sourcePosition:n,targetX:t,targetY:r,targetPosition:o}),{data:N,isPending:v,isError:E}=(({projectRef:e,connectionString:s,id:i},{enabled:a=!0,...t}={})=>(0,y.useQuery)({queryKey:A.replicaKeys.replicaLag(e,i),queryFn:({signal:a})=>ex({projectRef:e,connectionString:s,id:i},a),enabled:a&&void 0!==e&&void 0!==i,...t}))({id:g,projectRef:u,connectionString:f},{enabled:h===en.REPLICA_STATUS.ACTIVE_HEALTHY}),I=Number(N?.toFixed(2)??0).toLocaleString();return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(m.BaseEdge,{path:b,markerEnd:c,style:d}),void 0!==p&&!E&&h===en.REPLICA_STATUS.ACTIVE_HEALTHY&&(0,i.jsx)(m.EdgeLabelRenderer,{children:(0,i.jsxs)(eg.Tooltip,{children:[(0,i.jsx)(eg.TooltipTrigger,{asChild:!0,children:(0,i.jsx)("div",{className:"bg-surface-100 px-1.5 py-0.5 rounded absolute nodrag nopan",style:{transform:`translate(-50%, -50%) translate(${_}px,${S}px)`,pointerEvents:"all"},children:v?(0,i.jsx)(l.Loader2,{size:12,className:"animate-spin"}):(0,i.jsxs)("p",{className:"font-mono text-xs",children:[I,"s"]})})}),(0,i.jsx)(eg.TooltipContent,{side:"bottom",align:"center",children:v?`Checking replication lag for replica ID: ${j}`:`Replication lag (seconds) for replica ID: ${j}`})]})})]})};var ej=e.i(971104),eb=e.i(876553);let ey=e=>{let s=~~(e/3600),i=Math.floor(e%3600/60),a=Math.floor(e%60);return`${s>0?`${s}h`:""} ${i>0?`${i}m`:""} ${a>0?`${a}s`:""}`.trim()};var e_=e.i(55956),eA=e.i(667042),eS=e.i(471880),eN=e.i(382490),ev=e.i(471998),eE=e.i(4196),eI=e.i(423782),eT=e.i(101369),eC=e.i(276093),eR=e.i(189329),ew=e.i(587433);let eP=({data:e})=>{let{ref:s}=(0,x.useParams)(),{numDatabases:a}=e;return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("div",{className:"flex flex-col rounded bg-surface-100 border border-default",children:(0,i.jsxs)("div",{className:"flex items-start justify-between p-3 gap-x-4",style:{width:en.NODE_WIDTH/2-10},children:[(0,i.jsxs)("div",{className:"flex gap-x-3",children:[(0,i.jsx)("div",{className:"min-w-8 h-8 bg-blue-600 border border-blue-800 rounded-md flex items-center justify-center",children:(0,i.jsx)(eA.Database,{size:16})}),(0,i.jsxs)("div",{className:"flex flex-col gap-y-0.5",children:[(0,i.jsx)("p",{className:"text-sm",children:"API Load Balancer"}),(0,i.jsxs)("p",{className:"text-sm text-foreground-light",children:["Distributes incoming API requests across"," ",(0,i.jsxs)("span",{className:"text-foreground",children:[a," databases"]})]})]})]}),(0,i.jsxs)(w.DropdownMenu,{children:[(0,i.jsx)(w.DropdownMenuTrigger,{asChild:!0,children:(0,i.jsx)(R.Button,{type:"text",icon:(0,i.jsx)(ev.MoreVertical,{}),className:"px-1"})}),(0,i.jsx)(w.DropdownMenuContent,{className:"w-40",side:"bottom",align:"end",children:(0,i.jsx)(w.DropdownMenuItem,{asChild:!0,className:"gap-x-2",children:(0,i.jsx)(c.default,{href:`/project/${s}/settings/api?source=load-balancer`,children:"View API URL"})})})]})]})}),(0,i.jsx)(m.Handle,{type:"source",position:m.Position.Bottom,style:{background:"transparent"}})]})},eD=({data:e})=>{let{provider:s,region:a,computeSize:t,numReplicas:r,numRegions:n,hasLoadBalancer:l}=e,{projectHomepageShowInstanceSize:o}=(0,I.useIsFeatureEnabled)(["project_homepage:show_instance_size"]),{infraAwsNimbusLabel:d}=(0,eC.useCustomContent)(["infra:aws_nimbus_label"]);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(m.Handle,{type:"target",position:m.Position.Top,className:l?"":"opacity-0",style:{background:"transparent"}}),(0,i.jsxs)("div",{className:"flex flex-col rounded bg-surface-100 border border-default",children:[(0,i.jsxs)("div",{className:"flex items-start justify-between p-3",style:{width:en.NODE_WIDTH/2-10},children:[(0,i.jsxs)("div",{className:"flex gap-x-3",children:[(0,i.jsx)("div",{className:"w-8 h-8 bg-brand-500 border border-brand-600 rounded-md flex items-center justify-center",children:(0,i.jsx)(eA.Database,{size:16})}),(0,i.jsxs)("div",{className:"flex flex-col gap-y-0.5",children:[(0,i.jsx)("p",{className:"text-sm",children:"Primary Database"}),(0,i.jsx)("p",{className:"flex items-center gap-x-1",children:(0,i.jsx)("span",{className:"text-sm text-foreground-light",children:a.name})}),(0,i.jsxs)("p",{className:"flex items-center gap-x-1",children:[(0,i.jsx)("span",{className:"text-sm text-foreground-light",children:"AWS_NIMBUS"===s?d:s}),o&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("span",{className:"text-sm text-foreground-light",children:"•"}),(0,i.jsx)("span",{className:"text-sm text-foreground-light",children:t})]})]})]})]}),(0,i.jsx)("img",{alt:"region icon",className:"w-8 rounded-sm mt-0.5",src:`${Y.BASE_PATH}/img/regions/${a.region}.svg`})]}),r>0&&(0,i.jsx)("div",{className:"border-t p-3 py-2",children:(0,i.jsxs)("p",{className:"text-sm text-foreground-light",children:[(0,i.jsxs)("span",{className:"text-foreground",children:[r," replica",r>1?"s":""]})," ","deployed across"," ",(0,i.jsxs)("span",{className:"text-foreground",children:[n," region",n>1?"s":""]})]})})]}),(0,i.jsx)(m.Handle,{type:"source",position:m.Position.Bottom,className:0===r?"opacity-0":"",style:{background:"transparent"}})]})},eL=({data:e})=>{let{id:s,provider:t,region:r,computeSize:n,status:o,inserted_at:d,onSelectRestartReplica:p,onSelectResizeReplica:u,onSelectDropReplica:h}=e,{ref:g}=(0,x.useParams)(),f=(0,eR.useDatabaseSelectorStateSnapshot)(),{can:j}=(0,E.useAsyncCheckPermissions)(a.PermissionAction.CREATE,"projects"),{projectHomepageShowInstanceSize:b}=(0,I.useIsFeatureEnabled)(["project_homepage:show_instance_size"]),[,y]=(0,eE.useQueryState)("showConnect",eE.parseAsBoolean.withDefault(!1)),{data:_}=v({projectRef:g}),{replicaInitializationStatus:A}=(_??[]).find(e=>e.identifier===s)||{},{status:N,progress:T,estimations:C,error:D}=A??{status:void 0,progress:void 0,estimations:void 0,error:void 0},L=(0,e_.default)(d).format("DD MMM YYYY"),k=(void 0!==T?Number(T.split("_")[0]):0)/(Object.keys(en.INIT_PROGRESS).length-1),B=[en.REPLICA_STATUS.UNKNOWN,en.REPLICA_STATUS.COMING_UP,en.REPLICA_STATUS.GOING_DOWN,en.REPLICA_STATUS.RESTORING,en.REPLICA_STATUS.RESTARTING,en.REPLICA_STATUS.RESIZING,en.REPLICA_STATUS.INIT_READ_REPLICA].includes(o)||N===S.InProgress,{infraAwsNimbusLabel:O}=(0,eC.useCustomContent)(["infra:aws_nimbus_label"]);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(m.Handle,{type:"target",position:m.Position.Top,style:{background:"transparent"}}),(0,i.jsxs)("div",{className:"flex justify-between items-start rounded bg-surface-100 border border-default p-3",style:{width:en.NODE_WIDTH/2-10},children:[(0,i.jsxs)("div",{className:"flex gap-x-3",children:[(0,i.jsx)("div",{className:(0,P.cn)("w-8 h-8 border rounded-md flex items-center justify-center",o===en.REPLICA_STATUS.ACTIVE_HEALTHY&&N===S.Completed?"bg-brand-400 border-brand-500":"bg-surface-100 border-foreground/20"),children:B?(0,i.jsx)(l.Loader2,{className:"animate-spin",size:16}):(0,i.jsx)(eS.DatabaseBackup,{size:16})}),(0,i.jsxs)("div",{className:"flex flex-col gap-y-0.5",children:[(0,i.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,i.jsxs)("p",{className:"text-sm truncate",children:["Replica ",s.length>0&&`(ID: ${(0,eu.formatDatabaseID)(s)})`]}),N===S.InProgress||o===en.REPLICA_STATUS.COMING_UP||o===en.REPLICA_STATUS.UNKNOWN||o===en.REPLICA_STATUS.INIT_READ_REPLICA?(0,i.jsx)(ew.Badge,{children:"Coming up"}):N===S.Failed||o===en.REPLICA_STATUS.INIT_READ_REPLICA_FAILED?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(ew.Badge,{variant:"destructive",children:"Init failed"}),(0,i.jsxs)(eg.Tooltip,{children:[(0,i.jsx)(eg.TooltipTrigger,{children:(0,i.jsx)(eN.HelpCircle,{size:16})}),(0,i.jsx)(eg.TooltipContent,{side:"bottom",align:"end",alignOffset:-70,className:"w-60 text-center",children:"Replica failed to initialize. Please drop this replica and spin up a new one."})]})]}):o===en.REPLICA_STATUS.GOING_DOWN?(0,i.jsx)(ew.Badge,{children:"Going down"}):o===en.REPLICA_STATUS.RESTARTING?(0,i.jsx)(ew.Badge,{children:"Restarting"}):o===en.REPLICA_STATUS.RESIZING?(0,i.jsx)(ew.Badge,{children:"Resizing"}):o===en.REPLICA_STATUS.ACTIVE_HEALTHY?(0,i.jsx)(ew.Badge,{variant:"success",children:"Healthy"}):(0,i.jsx)(ew.Badge,{variant:"warning",children:"Unhealthy"})]}),(0,i.jsxs)("div",{className:"my-0.5",children:[(0,i.jsx)("p",{className:"text-sm text-foreground-light",children:r.name}),(0,i.jsxs)("p",{className:"flex text-sm text-foreground-light items-center gap-x-1",children:[(0,i.jsx)("span",{children:"AWS_NIMBUS"===t?O:t}),b&&!!n&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("span",{children:"•"}),(0,i.jsx)("span",{children:n})]})]})]}),N===S.InProgress&&void 0!==T?(0,i.jsxs)(eg.Tooltip,{children:[(0,i.jsx)(eg.TooltipTrigger,{asChild:!0,children:(0,i.jsx)("div",{className:"w-56",children:(0,i.jsx)(eT.default,{labelBottom:en.INIT_PROGRESS[T],labelBottomClass:"text-xs !normal-nums text-foreground-light",type:"horizontal",value:100*k,max:100,barClass:"bg-brand"})})}),void 0!==C&&(0,i.jsx)(eg.TooltipContent,{asChild:!0,side:"bottom",children:(0,i.jsxs)("div",{className:"w-56",children:[(0,i.jsx)("p",{className:"text-foreground-light mb-0.5",children:"Duration estimates:"}),void 0!==C.baseBackupDownloadEstimateSeconds&&(0,i.jsxs)("p",{children:["Base backup download:"," ",ey(C.baseBackupDownloadEstimateSeconds)]}),void 0!==C.walArchiveReplayEstimateSeconds&&(0,i.jsxs)("p",{children:["WAL archive replay:"," ",ey(C.walArchiveReplayEstimateSeconds)]})]})})]}):void 0!==D?(0,i.jsxs)("p",{className:"text-sm text-foreground-light",children:["Error: ",en.ERROR_STATES[D]]}):(0,i.jsxs)("p",{className:"text-sm text-foreground-light",children:["Created: ",L]})]})]}),(0,i.jsxs)(w.DropdownMenu,{children:[(0,i.jsx)(w.DropdownMenuTrigger,{asChild:!0,children:(0,i.jsx)(R.Button,{type:"text",icon:(0,i.jsx)(ev.MoreVertical,{}),className:"px-1"})}),(0,i.jsxs)(w.DropdownMenuContent,{className:"w-40",side:"bottom",align:"end",children:[(0,i.jsx)(w.DropdownMenuItem,{disabled:o!==en.REPLICA_STATUS.ACTIVE_HEALTHY,className:"gap-x-2",onClick:()=>{y(!0),f.setSelectedDatabaseId(s)},children:"View connection string"}),(0,i.jsx)(w.DropdownMenuItem,{className:"gap-x-2",disabled:o!==en.REPLICA_STATUS.ACTIVE_HEALTHY,children:(0,i.jsx)(c.default,{href:`/project/${g}/observability/database?db=${s}&chart=replication-lag`,children:"View replication lag"})}),(0,i.jsx)(w.DropdownMenuSeparator,{}),(0,i.jsx)(w.DropdownMenuItem,{className:"gap-x-2",onClick:()=>p(),disabled:o!==en.REPLICA_STATUS.ACTIVE_HEALTHY,children:"Restart replica"}),(0,i.jsx)(eI.DropdownMenuItemTooltip,{className:"gap-x-2 !pointer-events-auto",disabled:!j,onClick:()=>{j&&h()},tooltip:{content:{side:"left",text:"You need additional permissions to drop replicas"}},children:"Drop replica"})]})]})]})]})},ek=({data:e})=>{let{region:s,numReplicas:a}=e,t=20+(en.NODE_WIDTH/2-10)*a+(a-1)*(en.NODE_SEP+10);return(0,i.jsx)("div",{className:"relative flex justify-between rounded bg-black/10 border border-default border-white/10 border-2 p-3",style:{width:t,height:162},children:(0,i.jsxs)("div",{className:"absolute bottom-2 flex items-center justify-between gap-x-2",children:[(0,i.jsx)("img",{alt:"region icon",className:"w-5 rounded-sm",src:`${Y.BASE_PATH}/img/regions/${s.region}.svg`}),(0,i.jsx)("p",{className:"text-sm",children:s.name})]})})};var eB=e.i(228598),eO=e.i(863805),eM=e.i(396831),e$=e.i(589285);let eU=({onSelectDeployNewReplica:e,onSelectRestartReplica:s,onSelectDropReplica:r})=>{let{ref:n}=(0,x.useParams)(),l=(0,eR.useDatabaseSelectorStateSnapshot)(),{projectHomepageShowInstanceSize:o}=(0,I.useIsFeatureEnabled)(["project_homepage:show_instance_size"]),[d,u]=(0,p.useState)(!1),[h,m]=(0,p.useState)(1.5),[g,j]=(0,p.useState)([14,7]),[y,_]=(0,p.useState)(),{can:A}=(0,E.useAsyncCheckPermissions)(a.PermissionAction.CREATE,"projects"),[,S]=(0,eE.useQueryState)("showConnect",eE.parseAsBoolean.withDefault(!1)),{data:N}=(0,b.useReadReplicasQuery)({projectRef:n}),v=N??[],[[T],C]=(0,t.default)(v,e=>e.identifier===n),P=en.AVAILABLE_REPLICA_REGIONS.find(e=>T.region.includes(e.region))?.coordinates??[0,0],D=(0,eB.default)(C,e=>en.AVAILABLE_REPLICA_REGIONS.find(s=>e.region.includes(s.region))?.key),L=en.AVAILABLE_REPLICA_REGIONS.find(e=>e.coordinates===g)?.region??"",k=en.AVAILABLE_REPLICA_REGIONS.find(e=>e.region===L),B=v.filter(e=>e.region.includes(L)).sort((e,s)=>+(e.inserted_at>s.inserted_at)).sort(e=>e.identifier===n?-1:0);return(0,p.useEffect)(()=>{setTimeout(()=>u(!0),100)},[]),(0,i.jsxs)("div",{className:"bg-studio h-[500px] relative",children:[(0,i.jsx)(eO.ComposableMap,{projectionConfig:{scale:155},className:"w-full h-full",children:(0,i.jsxs)(eO.ZoomableGroup,{className:d?"transition-all duration-300":"",center:g,zoom:h,minZoom:1.5,maxZoom:2,filterZoomEvent:({constructor:{name:e}})=>!["MouseEvent","WheelEvent"].includes(e),children:[(0,i.jsx)(eO.Geographies,{geography:e$.default,children:({geographies:e})=>e.map(e=>(0,i.jsx)(eO.Geography,{geography:e,strokeWidth:.3,pointerEvents:"none",className:"fill-gray-800 stroke-gray-900 dark:fill-gray-300 dark:stroke-gray-200"},e.rsmKey))}),D.map(e=>{let s=en.AVAILABLE_REPLICA_REGIONS.find(s=>e.region.includes(s.region))?.coordinates;return s!==P?(0,i.jsx)(eO.Line,{from:s,to:P,stroke:"white",strokeWidth:1,strokeLinecap:"round",strokeOpacity:.2,strokeDasharray:"3, 3",className:"map-path"},`line-${e.identifier}-${T.identifier}`):null}),en.AVAILABLE_REPLICA_REGIONS.map(e=>{let s=v.filter(s=>s.region.includes(e.region))??[],a=en.AVAILABLE_REPLICA_REGIONS.find(s=>s.region===e.region)?.coordinates,t=0===s.length,r=s.some(e=>e.identifier===n),l=s.filter(e=>e.identifier!==n)??[];return(0,i.jsxs)(eO.Marker,{coordinates:a,onMouseEnter:()=>{_({x:a[0],y:a[1],region:{key:e.key,country:e.name,region:e.region,name:t?void 0:r?`Primary Database${l.length>0?` + ${l.length} replica${l.length>1?"s":""} `:""}`:`${l.length} Read Replica${l.length>1?"s":""} deployed`}})},onMouseLeave:()=>_(void 0),onClick:()=>{a&&(j(a),m(2))},children:[L===e.region&&(0,i.jsx)("circle",{r:4,className:`animate-ping ${t?"fill-border-stronger":"fill-brand"}`}),(0,i.jsx)("circle",{r:4,className:`cursor-pointer ${t?"fill-background-surface-300 stroke-border-stronger":r?"fill-brand stroke-brand-500":"fill-brand-500 stroke-brand-400"}`})]},e.key)}),void 0!==y&&1.5===h&&(0,i.jsx)(eO.Marker,{coordinates:[y.x-47,y.y-5],children:(0,i.jsx)("foreignObject",{width:220,height:66.25,children:(0,i.jsx)("div",{className:"bg-studio/50 rounded border",children:(0,i.jsxs)("div",{className:"px-3 py-2 flex flex-col",children:[(0,i.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,i.jsx)("img",{alt:"region icon",className:"w-4 rounded-sm",src:`${Y.BASE_PATH}/img/regions/${y.region.region}.svg`}),(0,i.jsx)("p",{className:"text-[10px]",children:y.region.country})]}),(0,i.jsx)("p",{className:`text-[10px] ${void 0===y.region.name?"text-foreground-light":""}`,children:y.region.name??"No databases deployed"})]})})})})]})}),2===h&&void 0!==L&&k&&(0,i.jsxs)("div",{className:"absolute bottom-4 right-4 flex flex-col bg-studio/50 backdrop-blur-sm border rounded w-[400px]",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between py-4 px-4 border-b",children:[(0,i.jsxs)("div",{children:[(0,i.jsxs)("p",{className:"text-xs text-foreground-light",children:[B.length," database",B.length>1?"s":""," deployed in"]}),(0,i.jsx)("p",{className:"text-sm",children:k.name})]}),(0,i.jsx)("img",{alt:"region icon",className:"w-10 rounded-sm",src:`${Y.BASE_PATH}/img/regions/${k.region}.svg`})]}),B.length>0&&(0,i.jsx)(eM.ScrollArea,{style:{height:B.length>2?"180px":"auto"},children:(0,i.jsx)("ul",{className:"flex flex-col divide-y",children:B.map(e=>{let a=(0,e_.default)(e.inserted_at).format("DD MMM YYYY, HH:mm:ss (ZZ)");return(0,i.jsxs)("li",{className:"text-sm px-4 py-2 flex items-center justify-between",children:[(0,i.jsxs)("div",{className:"flex flex-col gap-y-1",children:[(0,i.jsxs)("p",{className:"flex items-center gap-x-2",children:[e.identifier===n?"Primary Database":`Read Replica ${e.identifier.length>0&&`(ID: ${(0,eu.formatDatabaseID)(e.identifier)})`}`,e.status===en.REPLICA_STATUS.ACTIVE_HEALTHY?(0,i.jsx)(ew.Badge,{variant:"success",children:"Healthy"}):e.status===en.REPLICA_STATUS.COMING_UP?(0,i.jsx)(ew.Badge,{children:"Coming up"}):e.status===en.REPLICA_STATUS.RESTARTING?(0,i.jsx)(ew.Badge,{children:"Restarting"}):e.status===en.REPLICA_STATUS.RESIZING?(0,i.jsx)(ew.Badge,{children:"Resizing"}):(0,i.jsx)(ew.Badge,{variant:"warning",children:"Unhealthy"})]}),(0,i.jsxs)("p",{className:"text-xs text-foreground-light",children:["AWS",o?` • ${e.size}`:""]}),e.identifier!==n&&(0,i.jsxs)("p",{className:"text-xs text-foreground-light",children:["Created on: ",a]})]}),e.identifier!==n&&(0,i.jsxs)(w.DropdownMenu,{children:[(0,i.jsx)(w.DropdownMenuTrigger,{asChild:!0,children:(0,i.jsx)(R.Button,{type:"text",icon:(0,i.jsx)(ev.MoreVertical,{}),className:"px-1"})}),(0,i.jsxs)(w.DropdownMenuContent,{className:"w-40",side:"bottom",align:"end",children:[(0,i.jsx)(w.DropdownMenuItem,{className:"gap-x-2",disabled:e.status!==en.REPLICA_STATUS.ACTIVE_HEALTHY,onClick:()=>{S(!0),l.setSelectedDatabaseId(e.identifier)},children:"View connection string"}),(0,i.jsx)(w.DropdownMenuItem,{className:"gap-x-2",disabled:e.status!==en.REPLICA_STATUS.ACTIVE_HEALTHY,children:(0,i.jsx)(c.default,{href:`/project/${n}/observability/database?db=${e.identifier}&chart=replication-lag`,children:"View replication lag"})}),(0,i.jsx)(w.DropdownMenuSeparator,{}),(0,i.jsx)(w.DropdownMenuItem,{className:"gap-x-2",onClick:()=>s(e),disabled:e.status!==en.REPLICA_STATUS.ACTIVE_HEALTHY,children:"Restart replica"}),(0,i.jsx)(eI.DropdownMenuItemTooltip,{className:"gap-x-2 !pointer-events-auto",disabled:!A,onClick:()=>r(e),tooltip:{content:{side:"left",text:"You need additional permissions to drop replicas"}},children:"Drop replica"})]})]})]},e.identifier)})})}),(0,i.jsxs)("div",{className:`flex items-center justify-end gap-x-2 px-4 py-4 ${B.length>0?"border-t":""}`,children:[(0,i.jsx)(f.ButtonTooltip,{type:"default",disabled:!A,onClick:()=>e(k.key),tooltip:{content:{side:"bottom",text:A?void 0:"You need additional permissions to deploy replicas"}},children:"Deploy new replica here"}),(0,i.jsx)(R.Button,{type:"default",onClick:()=>{j([14,7]),m(1.5)},children:"Close"})]})]})]})};var eH=e.i(351895);let ez=({selectedReplica:e,onSuccess:s,onCancel:a})=>{let{ref:t}=(0,x.useParams)(),r=(0,G.useQueryClient)(),n=(0,eu.formatDatabaseID)(e?.identifier??""),{mutate:l,isPending:o}=(0,eH.useProjectRestartMutation)({onSuccess:()=>{D.toast.success(`Restarting read replica (ID: ${n})`),r.setQueriesData({queryKey:A.replicaKeys.list(t)},s=>s.map(s=>s.identifier===e?.identifier?{...s,status:en.REPLICA_STATUS.RESTARTING}:s)),s(),a()},onError:e=>{D.toast.error(`Failed to restart replica: ${e.message}`)}});return(0,i.jsxs)(ec.default,{size:"medium",loading:o,visible:void 0!==e,title:`Confirm to restart selected replica? (ID: ${n})`,confirmLabel:"Restart replica",confirmLabelLoading:"Restarting replica",onCancel:()=>a(),onConfirm:()=>t?void 0===e?D.toast.error("No replica selected"):void l({ref:t,identifier:e.identifier}):console.error("Project is required"),children:[(0,i.jsx)("p",{className:"text-sm",children:"Your replica will be offline for a few minutes while it is being restarted. Before restarting the replica, consider:"}),(0,i.jsx)("ul",{className:"text-sm text-foreground-light py-1 list-disc mx-4 space-y-1",children:(0,i.jsx)("li",{children:"Network traffic from this region may slow down while the replica is restarting, especially if you have no other replicas in this region"})}),(0,i.jsx)("p",{className:"text-sm mt-2",children:"Are you sure you want to restart this replica now?"})]})};var eG=e.i(49589);let eV=({diagramOnly:e=!1})=>{let s=(0,m.useReactFlow)(),y=(0,T.useIsOrioleDb)(),{resolvedTheme:_}=(0,d.useTheme)(),{ref:A}=(0,x.useParams)(),{isPending:N}=(0,T.useSelectedProjectQuery)(),D=(0,T.useIsAwsCloudProvider)(),{infrastructureReadReplicas:L}=(0,I.useIsFeatureEnabled)(["infrastructure:read_replicas"]),[k,B]=(0,p.useState)("flow"),[O,M]=(0,p.useState)(!1),{showNewReplicaPanel:$,setShowNewReplicaPanel:U}=(0,eG.useShowNewReplicaPanel)(),[H,z]=(0,p.useState)(1e4),[G,V]=(0,p.useState)(),[W,F]=(0,p.useState)(),[Y,Q]=(0,p.useState)(),{can:K}=(0,E.useAsyncCheckPermissions)(a.PermissionAction.CREATE,"projects"),{data:Z,refetch:X,isSuccess:J}=(0,j.useLoadBalancersQuery)({projectRef:A}),{data:ee,error:es,refetch:ei,isPending:ea,isError:et,isSuccess:er}=(0,b.useReadReplicasQuery)({projectRef:A}),[[eo],ed]=(0,p.useMemo)(()=>(0,t.default)(ee??[],e=>e.identifier===A),[ee,A]),{data:ec,isSuccess:eu}=v({projectRef:A},{refetchInterval:H,refetchOnWindowFocus:!1}),em=(0,p.useMemo)(()=>ee?.length??0,[ee]);(0,p.useEffect)(()=>{eu&&(async()=>{let e=[en.REPLICA_STATUS.ACTIVE_HEALTHY,en.REPLICA_STATUS.ACTIVE_UNHEALTHY,en.REPLICA_STATUS.INIT_READ_REPLICA_FAILED],s=ec.filter(s=>{let{status:i}=s.replicaInitializationStatus||{};return!e.includes(s.status)||i===S.InProgress}).length>0;ec.length!==em&&(await ei(),setTimeout(()=>X(),2e3)),s||z(!1)})()},[em,eu,X,ei,ec]);let ex=(0,p.useMemo)(()=>er&&J&&void 0!==eo?(({primary:e,replicas:s,loadBalancers:i,onSelectRestartReplica:a,onSelectDropReplica:t})=>{let r={x:0,y:0},n=(0,eb.default)(s,e=>{let s=en.AVAILABLE_REPLICA_REGIONS.find(s=>e.region.includes(s.region));return s?.key}),l=i.find(s=>s.databases.some(s=>s.identifier===e.identifier)),o=void 0!==l?{position:r,id:"load-balancer",type:"LOAD_BALANCER",data:{numDatabases:l.databases.length}}:void 0,d=Object.keys(q.AWS_REGIONS).map(e=>({key:e,name:q.AWS_REGIONS?.[e].displayName,region:q.AWS_REGIONS?.[e].code,coordinates:en.AWS_REGIONS_COORDINATES[e]})).find(s=>e.region.includes(s.region));return[...void 0!==o?[o]:[],{position:r,id:e.identifier,type:"PRIMARY",data:{id:e.identifier,region:"FLY"===e.cloud_provider?{name:"Singapore (sin)",key:"SOUTHEAST_ASIA"}:d??{name:e.region},provider:e.cloud_provider,inserted_at:e.inserted_at,computeSize:e.size,status:e.status,numReplicas:s.length,numRegions:Object.keys(n).length,hasLoadBalancer:void 0!==l}},...s.sort((e,s)=>e.region>s.region?1:-1).map(e=>{let s=en.AVAILABLE_REPLICA_REGIONS.find(s=>e.region.includes(s.region));return{position:r,id:e.identifier,type:"READ_REPLICA",data:{id:e.identifier,region:s,provider:e.cloud_provider,inserted_at:e.inserted_at,computeSize:e.size,status:e.status,onSelectRestartReplica:()=>a(e),onSelectDropReplica:()=>t(e)}}})]})({primary:eo,replicas:ed,loadBalancers:Z??[],onSelectRestartReplica:Q,onSelectDropReplica:F}):[],[er,J,eo,ed,Z]),eg=(0,p.useMemo)(()=>er&&J?[...(Z??[]).length>0?[{id:`load-balancer-${eo.identifier}`,source:"load-balancer",target:eo.identifier,type:"smoothstep",animated:!0,className:"!cursor-default"}]:[],...ed.map(e=>({id:`${eo.identifier}-${e.identifier}`,source:eo.identifier,target:e.identifier,type:"smoothstep",animated:!0,className:"!cursor-default",data:{status:e.status,identifier:e.identifier,connectionString:e.connectionString}}))]:[],[J,er,Z,eo?.identifier,ed]),ey=(0,p.useMemo)(()=>({PRIMARY:eD,READ_REPLICA:eL,REGION:ek,LOAD_BALANCER:eP}),[]),e_=(0,p.useMemo)(()=>({smoothstep:ef}),[]),eA=async()=>{var e,i;let a,t,r,n=((a=new ej.default.graphlib.Graph).setDefaultEdgeLabel(()=>({})),a.setGraph({rankdir:"TB",ranksep:160,nodesep:en.NODE_SEP}),ex.forEach(e=>{a.setNode(e.id,{width:en.NODE_WIDTH/2,height:"load-balancer"===e.id?-70:en.NODE_ROW_HEIGHT/2})}),eg.forEach(e=>a.setEdge(e.source,e.target)),ej.default.layout(a),ex.forEach(e=>{let s=a.node(e.id);return e.targetPosition=m.Position.Top,e.sourcePosition=m.Position.Bottom,e.position={x:s.x-s.width/2,y:s.y-s.height/2},e}),{nodes:ex,edges:eg}),{nodes:l}=(e=n.nodes,i=n.edges,t=[],r=e.filter(e=>"READ_REPLICA"===e.type),Object.entries((0,eb.default)(r,e=>e.data.region.key)).map(([e,s])=>{let i=en.AVAILABLE_REPLICA_REGIONS.find(s=>s.key===e),a=s.map(e=>e.position.x),r=s.map(e=>e.position.y),n=Math.min(...a),l={id:e,position:{x:n-10,y:Math.max(...r)-10},width:Math.max(...a)-n+en.NODE_WIDTH/2,type:"REGION",data:{region:i,numReplicas:s.length}};t.push(l)}),{nodes:[...t,...e],edges:i});s.setNodes(l),s.setEdges(n.edges),await (0,C.timeout)(1),s.fitView({maxZoom:.9,minZoom:.9})};return(0,p.useEffect)(()=>{er&&J&&ex.length>0&&"flow"===k&&eA()},[er,J,ex,eg,k]),(0,i.jsxs)("div",{className:(0,P.cn)("nowheel",e?"h-full":"border-y"),children:[(0,i.jsxs)("div",{className:`${e?"h-full":"h-[500px]"} w-full relative ${er&&!N?"":"flex items-center justify-center px-28"}`,children:[(ea||N)&&(0,i.jsx)(l.Loader2,{className:"animate-spin text-foreground-light"}),et&&(0,i.jsx)(g.default,{error:es,subject:"Failed to retrieve replicas"}),er&&!N&&(0,i.jsxs)(i.Fragment,{children:[!e&&L&&(0,i.jsxs)("div",{className:"z-10 absolute top-4 right-4 flex items-center justify-center gap-x-2",children:[(0,i.jsxs)("div",{className:"flex items-center justify-center",children:[(0,i.jsx)(f.ButtonTooltip,{type:"default",disabled:!K||y,className:(0,P.cn)(ed.length>0?"rounded-r-none":""),onClick:()=>U(!0),tooltip:{content:{side:"bottom",text:K?y?"Read replicas are not supported with OrioleDB":void 0:"You need additional permissions to deploy replicas"}},children:"Deploy a new replica"}),ed.length>0&&(0,i.jsxs)(w.DropdownMenu,{children:[(0,i.jsx)(w.DropdownMenuTrigger,{asChild:!0,children:(0,i.jsx)(R.Button,{type:"default",icon:(0,i.jsx)(r.ChevronDown,{size:16}),className:"px-1 rounded-l-none border-l-0"})}),(0,i.jsxs)(w.DropdownMenuContent,{align:"end",className:"w-52 *:space-x-2",children:[(0,i.jsx)(w.DropdownMenuItem,{asChild:!0,children:(0,i.jsx)(c.default,{href:`/project/${A}/settings/compute-and-disk`,children:"Resize databases"})}),(0,i.jsx)(w.DropdownMenuSeparator,{}),(0,i.jsx)(w.DropdownMenuItem,{onClick:()=>M(!0),children:(0,i.jsx)("div",{children:"Remove all replicas"})})]})]})]}),D&&(0,i.jsxs)("div",{className:"flex items-center justify-center",children:[(0,i.jsx)(R.Button,{type:"default",icon:(0,i.jsx)(o.Network,{size:15}),className:`rounded-r-none transition ${"flow"===k?"opacity-100":"opacity-50"}`,onClick:()=>B("flow")}),(0,i.jsx)(R.Button,{type:"default",icon:(0,i.jsx)(n,{size:15}),className:`rounded-l-none transition ${"map"===k?"opacity-100":"opacity-50"}`,onClick:()=>B("map")})]})]}),"flow"===k?(0,i.jsx)(u.default,{fitView:!0,fitViewOptions:{minZoom:.9,maxZoom:.9},className:"instance-configuration",zoomOnPinch:!1,zoomOnScroll:!1,nodesDraggable:!1,nodesConnectable:!1,zoomOnDoubleClick:!1,edgesFocusable:!1,edgesUpdatable:!1,defaultNodes:[],defaultEdges:[],nodeTypes:ey,edgeTypes:e_,proOptions:{hideAttribution:!0},children:(0,i.jsx)(h.Background,{color:"dark"===_?"rgba(255, 255, 255, 0.3)":"rgba(0, 0, 0, 0.4)"})}):(0,i.jsx)(eU,{onSelectDeployNewReplica:e=>{V(e),U(!0)},onSelectRestartReplica:Q,onSelectDropReplica:F})]})]}),!e&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(el,{visible:$,selectedDefaultRegion:G,onSuccess:()=>z(5e3),onClose:()=>{V(void 0),U(!1)}}),(0,i.jsx)(eh,{selectedReplica:W,onSuccess:()=>z(5e3),onCancel:()=>F(void 0)}),(0,i.jsx)(ep,{visible:O,onSuccess:()=>z(5e3),onCancel:()=>M(!1)}),(0,i.jsx)(ez,{selectedReplica:Y,onSuccess:()=>z(5e3),onCancel:()=>Q(void 0)})]})]})};e.s(["InstanceConfiguration",0,({diagramOnly:e=!1})=>(0,i.jsx)(m.ReactFlowProvider,{children:(0,i.jsx)(eV,{diagramOnly:e})})],554056)}]);

//# debugId=557f2969-4ddc-2762-1963-989e6985eb34
//# sourceMappingURL=1832262594779f5e.js.map